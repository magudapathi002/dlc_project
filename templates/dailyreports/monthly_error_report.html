{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monthly ERROR Reports</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom animation styles -->
  <style>
    /* page fade-in */
    @keyframes pageFadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-page-fade {
      animation: pageFadeIn 420ms cubic-bezier(.2,.9,.2,1) both;
    }

    /* card slide up */
    @keyframes cardSlideUp {
      from { opacity: 0; transform: translateY(12px) scale(.995); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-card-up {
      animation: cardSlideUp 520ms cubic-bezier(.16,.84,.24,1) both;
    }

    /* header shimmer */
    @keyframes headerShimmer {
      0% { box-shadow: 0 0 0 rgba(255,255,255,0); }
      50% { box-shadow: 0 6px 30px rgba(0,0,0,0.06); }
      100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
    }
    .header-shimmer {
      animation: headerShimmer 2200ms ease-in-out infinite;
    }

    /* row reveal (fade+up) */
    @keyframes rowReveal {
      from { opacity: 0; transform: translateY(8px) scale(.998); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .row-hidden {
      opacity: 0;
      transform: translateY(8px);
    }
    .row-reveal {
      animation: rowReveal 360ms cubic-bezier(.2,.9,.3,1) both;
    }

    /* subtle hover lift */
    .row-hover-lift {
      transition: transform 200ms cubic-bezier(.2,.9,.2,1), box-shadow 200ms;
    }
    .row-hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }

    /* make table scroll smooth */
    #compact-scroll-area { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

    /* small responsive tweak for density */
    @media (max-width: 640px) {
      .grid-template-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr !important; }
    }
  </style>

  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>

<body class="bg-gray-100 text-gray-800 animate-page-fade">
  {% include "partials/navbar.html" %}
  <div class="max-w-7xl mx-auto mt-6 p-3">
    <div class="flex gap-6">
      <aside class="w-64 hidden lg:block sticky top-16 h-screen overflow-auto">
        {% include "partials/sidebar.html" %}
      </aside>

      <div class="flex-1">
        <div class="flex item-left mx-auto p-0">
          <div class="grid grid-cols-1 lg:grid-cols-6 gap-3 w-full">
            <main class="lg:col-span-5 w-full">
              <div class="bg-white shadow-md rounded-lg overflow-hidden animate-card-up">

                <div class="flex items-center justify-between p-4 border-b header-shimmer">
                  <div>
                    <h1 class="text-xl font-semibold">Monthly ERROR Reports</h1>
                    <p class="text-sm text-gray-500">Select month &amp; year and view state-wise report</p>
                  </div>
                </div>

                <div class="p-4">
                  <form method="GET" id="monthYearForm" class="flex flex-col md:flex-row md:items-center gap-3">
                    <label for="month_select" class="sr-only">Month</label>
                    <select id="month_select" name="month" class="w-full md:w-40 p-2 border rounded-md bg-white text-sm">
                      <option value="">-- Month --</option>
                      <option value="01" {% if selected_month == "01" %}selected{% endif %}>January</option>
                      <option value="02" {% if selected_month == "02" %}selected{% endif %}>February</option>
                      <option value="03" {% if selected_month == "03" %}selected{% endif %}>March</option>
                      <option value="04" {% if selected_month == "04" %}selected{% endif %}>April</option>
                      <option value="05" {% if selected_month == "05" %}selected{% endif %}>May</option>
                      <option value="06" {% if selected_month == "06" %}selected{% endif %}>June</option>
                      <option value="07" {% if selected_month == "07" %}selected{% endif %}>July</option>
                      <option value="08" {% if selected_month == "08" %}selected{% endif %}>August</option>
                      <option value="09" {% if selected_month == "09" %}selected{% endif %}>September</option>
                      <option value="10" {% if selected_month == "10" %}selected{% endif %}>October</option>
                      <option value="11" {% if selected_month == "11" %}selected{% endif %}>November</option>
                      <option value="12" {% if selected_month == "12" %}selected{% endif %}>December</option>
                    </select>

                    <label for="year_select" class="sr-only">Year</label>
                    <select id="year_select" name="year" class="w-full md:w-28 p-2 border rounded-md bg-white text-sm">
                      <!-- JS will populate years and pre-select -->
                    </select>

                    <button type="submit" id="viewBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">VIEW</button>

                    <button type="button" id="exportCsvBtn" class="inline-flex items-center gap-2 px-3 py-2 border rounded-md text-sm text-gray-700 ml-auto md:ml-0 hover:bg-gray-50">Export Excel</button>

                    <button type="button" id="refreshBtn" class="inline-flex items-center gap-2 px-3 py-2 border rounded-md text-sm text-gray-700 hover:bg-gray-50" title="Reload page">Refresh</button>
                  </form>
                </div>

                <div class="p-4 border-t">
                  <div class="mx-auto max-w-full">
                    <div class="bg-white border rounded-lg shadow-sm">
                      <div class="bg-green-700 text-white text-sm font-semibold rounded-t-lg">
                        <div class="grid grid-cols-5 gap-0 text-xs sm:text-sm">
                          <div class="px-3 py-2">Date</div>
                          <div class="px-3 py-2">Forecast (MU)</div>
                          <div class="px-3 py-2">Actual Reported By SRLDC (MU)</div>
                          <div class="px-3 py-2 text-right">Abs. Deviation (MU)</div>
                          <div class="px-3 py-2 text-right">Abs. Error (%)</div>
                        </div>
                      </div>

                      <div id="compact-scroll-area" class="max-h-[420px] sm:max-h-[520px] overflow-auto">
                        <table id="emptyTemplateTable" class="min-w-full table-fixed border-collapse text-sm">
                          <thead class="hidden"></thead>

                          <!-- SERVER-RENDERED ROWS -->
                          <tbody id="empty-tbody" class="divide-y divide-gray-100">
                            {% for r in rows %}
                              <tr class="hover:bg-gray-50 text-sm row-hover-lift row-hidden"
                                  style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                                <td class="px-3 py-2 text-xs sm:text-sm">{{ r.date_display }}</td>
                                <td class="px-3 py-2 text-xs sm:text-sm">&nbsp;</td>
                                <td class="px-3 py-2 text-xs sm:text-sm">
                                  {% if r.actual is not None %}
                                    {{ r.actual|floatformat:2 }}
                                  {% else %}
                                    &nbsp;
                                  {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs sm:text-sm text-right">&nbsp;</td>
                                <td class="px-3 py-2 text-xs sm:text-sm text-right">&nbsp;</td>
                              </tr>
                            {% endfor %}

                            <tr class="bg-gray-100 font-semibold row-hidden"
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                              <td class="px-3 py-2 text-xs sm:text-sm">Total</td>
                              <td class="px-3 py-2 text-xs sm:text-sm">&nbsp;</td>
                              <td class="px-3 py-2 text-xs sm:text-sm">
                                {% if total_actual is not None %}
                                  {{ total_actual|floatformat:2 }}
                                {% else %}
                                  &nbsp;
                                {% endif %}
                              </td>
                              <td class="px-3 py-2 text-xs sm:text-sm text-right">&nbsp;</td>
                              <td class="px-3 py-2 text-xs sm:text-sm text-right">&nbsp;</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                    </div>

                    <div class="mt-3 text-xs text-gray-500">Compact boxed view â€” scroll inside the box. Click VIEW to request server data; Export Excel downloads the displayed table.</div>

                  </div>
                </div>

              </div>
            </main>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Prevent leftover client-side builder from overwriting server rows -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // mark server-rendered present
      window.__SERVER_RENDERED = true;

      // if some older script defined buildEmptyTemplate() and auto-called it,
      // override it so it won't clear the server rows.
      if (typeof window.buildEmptyTemplate === 'function') {
        window._buildEmptyTemplate_backup = window.buildEmptyTemplate;
        window.buildEmptyTemplate = function() { return; };
      }

      // Staggered reveal for table rows (server-rendered)
      const rows = Array.from(document.querySelectorAll('#empty-tbody tr.row-hidden'));
      rows.forEach((tr, i) => {
        // stagger timing (short)
        const delay = 70 + (i * 30); // ms
        setTimeout(() => {
          tr.classList.remove('row-hidden');
          tr.classList.add('row-reveal');
        }, delay);
      });
    });
  </script>

  <!-- year select population + csv export + refresh -->
  <script>
    (function populateYears() {
      const yearSelect = document.getElementById('year_select');
      const now = new Date();
      const currentYear = now.getFullYear();
      const start = currentYear - 5;
      const end = currentYear + 5;
      const selectedYear = "{{ selected_year|default:'' }}";
      for (let y = end; y >= start; y--) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if (selectedYear && String(y) === String(selectedYear)) opt.selected = true;
        yearSelect.appendChild(opt);
      }
    })();

    function compactTableToCSV(filename = 'psp-compact-empty.csv') {
      const table = document.getElementById('emptyTemplateTable');
      if (!table) { alert('No table to export.'); return; }
      const rows = [];
      const headers = ['Date','Forecast (MU)','Actual Reported By SRLDC (MU)','Abs. Deviation (MU)','Abs. Error (%)'];
      rows.push(headers.join(','));
      const trs = table.querySelectorAll('tbody tr');
      trs.forEach(tr => {
        const cols = Array.from(tr.querySelectorAll('td')).map(td => {
          let text = td.textContent.trim().replace(/"/g, '""');
          if (text.includes(',')) text = `"${text}"`;
          return text;
        });
        rows.push(cols.join(','));
      });
      const csv = rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById('exportCsvBtn').addEventListener('click', compactTableToCSV);
    document.getElementById('refreshBtn').addEventListener('click', function () { location.reload(); });
  </script>

  {% block content %}{% endblock %}
</body>
</html>
